<div class="mad-datatable-action-bar">
  <!-- Table actions: displayed before the table -->
  <div *ngIf="tableActions?.length || (filterMode === 'COLUMN_BASED' && showDeleteFilterAction)">
    <mad-button-group *ngFor="let actionGroup of tableActions" class="table-action-group">
      <mad-outline-button
        [hidden]="isHidden(tableAction)"
        [disabled]="isDisabled(tableAction)"
        *ngFor="let tableAction of actionGroup"
        (click)="onTableAction(tableAction)"
      >
        {{ translateLabels ? (tableAction.label | translate) : tableAction.label }}
        {{ getSelectedCount(tableAction.type) }}
      </mad-outline-button>
    </mad-button-group>
    <ng-container *ngIf="filterMode === 'COLUMN_BASED' && showDeleteFilterAction">
      <mad-outline-button (click)="deleteFilter()">
        <mat-icon fontSet="material-icons-outlined">filter_alt_off</mat-icon>
        {{ translateLabels ? (deleteFilterLabel | translate) : deleteFilterLabel }}
      </mad-outline-button>
    </ng-container>
  </div>
  <!-- Table filter -->
  <mat-form-field *ngIf="filterMode === 'TABLE_BASED'">
    <mat-label>{{ translateLabels ? (filterLabel | translate) : filterLabel }}</mat-label>
    <input matInput autocomplete="off" (keyup)="updateFilterValue($event)" placeholder="{{ filterPlaceholder }}" />
  </mat-form-field>
</div>

<!-- Row action menu -->
<mat-menu #rowActionMenu="matMenu">
  <ng-template matMenuContent let-element="element">
    <button
      *ngFor="let rowAction of rowActions"
      mat-menu-item
      class="row-action"
      (click)="onRowEvent($event, element, rowAction)"
      [hidden]="isHidden(rowAction)"
      [disabled]="isDisabled(rowAction)"
    >
      {{ translateLabels ? (rowAction.label | translate) : rowAction.label }}
    </button>
  </ng-template>
</mat-menu>

<!-- editable definition menu -->
<mat-menu #editableDefinitionMenu="matMenu">
  <ng-template matMenuContent>
    <button
      *ngFor="let definition of editableColumnDefinitions"
      mat-menu-item
      class="row-action"
      (click)="onColumnSettings(definition)"
      [ngClass]="{ 'active-column-definition': isCurrentDefinition(definition) }"
    >
      {{ translateLabels ? (definition.label | translate) : definition.label }}
    </button>
  </ng-template>
</mat-menu>

<!-- viewable definition menu -->
<mat-menu #viewableDefinitionMenu="matMenu">
  <ng-template matMenuContent>
    <button
      *ngFor="let definition of viewableColumnDefinitions"
      mat-menu-item
      class="row-action"
      (click)="onViewDefinition(definition)"
      [ngClass]="{ 'active-column-definition': isCurrentDefinition(definition) }"
    >
      {{ translateLabels ? (definition.label | translate) : definition.label }}
    </button>
  </ng-template>
</mat-menu>

<!-- Table -->
<div
  *ngIf="filterMode === 'COLUMN_BASED' || showEmptyTable || rowCount > 0; else noData"
  class="datatable"
  [class]="tableClass"
>
  <div class="mad-datatable-spinner-wrapper" *ngIf="isLoading">
    <mat-spinner [diameter]="50" [strokeWidth]="3"></mat-spinner>
  </div>

  <table
    [id]="id"
    mat-table
    [dataSource]="dataSource"
    matSort
    (matSortChange)="onSortingEvent($event)"
    madFilter
    (madFilterChange)="onFilteringEvent($event)"
  >
    <!-- Row actions column-->
    <ng-container [matColumnDef]="ACTION_COLUMN_NAME">
      <th
        scope="col"
        mat-header-cell
        *matHeaderCellDef
        [ngClass]="selectionEmitMode === NONE ? 'no-action-cell' : 'row-action-cell'"
      >
        <!-- BATCH: master checkbox -->
        <div *ngIf="selectionEmitMode !== 'NONE' && selectionMode === BATCH" class="mad-datatable-checkbox-container">
          <mat-checkbox (change)="onToggleSelectAll()" [checked]="allSelected"> </mat-checkbox>
        </div>
        <!-- SINGLE / NONE: nothing in header row -->
      </th>
      <td
        mat-cell
        *matCellDef="let element"
        [ngClass]="selectionEmitMode === NONE ? 'no-action-cell' : 'row-action-cell'"
      >
        <!-- BATCH: row checkbox -->
        <div
          *ngIf="!element.parentId && selectionMode === BATCH"
          class="mad-datatable-checkbox-container"
          (click)="onRowEvent($event, element)"
        >
          <mat-checkbox class="no-pointer-events" [checked]="isSelected(element.rowId)"> </mat-checkbox>
        </div>
        <!-- SINGLE: row action menu icon -->
        <mad-icon-button
          *ngIf="!element.parentId && selectionEmitMode === 'ON_ACTION' && selectionMode === SINGLE"
          [matMenuTriggerData]="{ element: element }"
          [matMenuTriggerFor]="rowActionMenu"
          (click)="updateSelection(element.rowId)"
        >
          <mat-icon>more_vert</mat-icon>
        </mad-icon-button>
        <!-- SINGLE: row radio button -->
        <div
          *ngIf="!element.parentId && selectionEmitMode === 'ON_SELECTION' && selectionMode === SINGLE"
          class="mad-datatable-checkbox-container"
          (click)="onRowEvent($event, element)"
        >
          <mat-radio-button class="no-pointer-events" [checked]="isSelected(element.rowId)"> </mat-radio-button>
        </div>
        <!-- NONE: nothing -->
      </td>
    </ng-container>
    <!-- Cell definitions and rows with injected cells -->
    <ng-container *ngFor="let column of columns" [matColumnDef]="column.id">
      <!-- header cell to be injected -->
      <ng-container [ngSwitch]="getDataTableHeaderType(column)">
        <ng-container *ngSwitchCase="'SORT'">
          <th
            scope="col"
            mat-header-cell
            *matHeaderCellDef
            [class.text-right]="column.isRightAligned"
            mat-sort-header="{{ column.orderByName ? column.orderByName : column.dataPropertyName }}"
            [arrowPosition]="column.isRightAligned ? 'before' : 'after'"
          >
            {{ translateLabels ? (column.label | translate) : column.label }}
          </th>
        </ng-container>
        <ng-container *ngSwitchCase="'FILTER'">
          <th
            scope="col"
            mat-header-cell
            *matHeaderCellDef
            [class.text-right]="column.isRightAligned"
            mad-filter-header="{{ column.dataPropertyName }}"
            [madFilterOptions]="column.filterParams?.filterOptions"
          >
            {{ translateLabels ? (column.label | translate) : column.label }}
          </th>
        </ng-container>
        <ng-container *ngSwitchCase="'SORT_AND_FILTER'">
          <th
            scope="col"
            mat-header-cell
            *matHeaderCellDef
            [class.text-right]="column.isRightAligned"
            mat-sort-header="{{ column.orderByName ? column.orderByName : column.dataPropertyName }}"
            [arrowPosition]="column.isRightAligned ? 'before' : 'after'"
            mad-filter-header="{{ column.dataPropertyName }}"
            [madFilterOptions]="column.filterParams?.filterOptions"
          >
            {{ translateLabels ? (column.label | translate) : column.label }}
          </th>
        </ng-container>
        <ng-container *ngSwitchDefault>
          <th scope="col" mat-header-cell *matHeaderCellDef [class.text-right]="column.isRightAligned">
            {{ translateLabels ? (column.label | translate) : column.label }}
          </th>
        </ng-container>
      </ng-container>

      <!-- data cell to be injected -->
      <td
        mat-cell
        *matCellDef="let element"
        [class.text-right]="column.isRightAligned"
        [class.mad-dt-child-cell]="element.parentId"
        [ngSwitch]="column.transformer"
        (click)="onRowEvent($event, element)"
      >
        <ng-container
          *ngTemplateOutlet="
            getCustomCellTemplate(column.id) || defaultCellTemplate;
            context: { column: column, element: element, $implicit: element }
          "
        ></ng-container>
      </td>
    </ng-container>
    <!-- header row where cells will be injected -->
    <tr mat-header-row *matHeaderRowDef="columnIds"></tr>
    <!-- data row where cells will be injected -->
    <tr
      mat-row
      [class.clickable-table-row]="!row.parentId && isRowClickable"
      *matRowDef="let row; columns: columnIds"
    ></tr>
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell noDataText columnBasedFilter" [attr.colspan]="columnIds.length">
        {{ translateLabels ? (noDataText | translate) : noDataText }}
      </td>
    </tr>
  </table>
</div>
<div class="mad-data-table-bottom-area">
  <div class="mad-data-table-bottom-info-area">
    <!-- column settings: 1 definition -->
    <mad-icon-button *ngIf="this.editableColumnDefinitions?.length === 1" (click)="onColumnSettings()">
      <mat-icon class="material-icons-outlined">view_column</mat-icon>
    </mad-icon-button>
    <!-- column settings: multiple definitions -->
    <mad-icon-button
      *ngIf="(this.editableColumnDefinitions?.length || 0) > 0"
      [matMenuTriggerFor]="editableDefinitionMenu"
    >
      <mat-icon>view_column</mat-icon>
    </mad-icon-button>
    <!-- column view: multiple definitions -->
    <mad-icon-button
      *ngIf="(this.viewableColumnDefinitions?.length || 0) > 0"
      [matMenuTriggerFor]="viewableDefinitionMenu"
    >
      <mat-icon>preview</mat-icon>
    </mad-icon-button>
  </div>

  <!-- Pagination -->
  <mat-paginator
    [style.display]="isPaginationEnabled ? 'block' : 'none'"
    [length]="paginatorLength"
    [pageIndex]="paginatorPageIndex"
    [pageSize]="paginatorPageSize"
    [pageSizeOptions]="pageSizeOptions"
    (page)="onPageEvent($event)"
    showFirstLastButtons
  >
  </mat-paginator>
</div>

<!-- No data alert -->
<ng-template #noData>
  <div class="noDataText">
    <div class="mad-datatable-spinner-wrapper" *ngIf="isLoading">
      <mat-spinner [diameter]="50" [strokeWidth]="3"></mat-spinner>
    </div>
    {{ translateLabels ? (noDataText | translate) : noDataText }}
  </div>
</ng-template>

<!-- default cell template -->
<ng-template #defaultCellTemplate let-element="element" let-column="column">
  <span>
    {{ element[column.dataPropertyName] }}
  </span>
</ng-template>

<!-- custom cell templates injected from parent -->
<ng-content></ng-content>
